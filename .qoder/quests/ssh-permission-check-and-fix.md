# SSH 私钥权限检查修复及配置文件自动生成功能

## 功能背景

当前 Gradle Remote Plugin 已实现了 SSH 配置文件的自动注入功能，但仍存在影响开箱即用体验的问题：

1. **权限问题**：项目中的 SSH 私钥文件在版本控制系统中被提交和检出后，文件权限可能不符合 SSH 的安全要求（必须是 600），导致 SSH 客户端拒绝使用，无法连接远程服务器

2. **初始化配置缺失**：新项目或团队新成员首次使用时，需要手动创建 `remote.yml`、`.ssh/config` 和私钥文件，配置门槛较高

## 功能目标

实现真正的零配置、开箱即用：

- 自动检测和修复私钥文件权限
- 首次使用时自动生成必要的配置文件和密钥
- 确保团队成员克隆代码后无需任何配置即可使用

## 功能范围

### 一、私钥权限检查和修复

#### 目标目录

`{项目根目录}/gradle/remote-plugin/.ssh/`

#### 需要处理的文件

仅处理私钥文件，不处理公钥、config、known_hosts、authorized_keys 等其他文件。

| 文件类型 | 识别规则 | 正确权限 | 说明 |
|---------|---------|---------|------|
| 私钥文件 | 符合私钥命名规则的文件 | 600 | 仅所有者可读写 |
| .ssh 目录 | - | 700 | 仅所有者可读写执行 |

#### 私钥文件识别逻辑

采用**文件名初筛 + 文件内容检测**的两阶段识别方式，确保精准识别：

**第一阶段：文件名初筛（快速排除）**

满足以下任一条件进入内容检测：
1. 文件名完全匹配标准私钥名称：`id_rsa`, `id_dsa`, `id_ecdsa`, `id_ed25519`
2. 文件名以标准私钥名称开头（如 `id_rsa_myserver`、`id_ed25519_prod`）
3. 扩展名为 `.pem`
4. 扩展名为 `.key`
5. 文件名包含 `private` 且不包含 `.pub`

快速排除条件：
- 文件名包含 `.pub` 或 `public` - 公钥文件，直接跳过
- 文件名为 `config` - 配置文件，直接跳过
- 文件名为 `known_hosts` 或 `authorized_keys` - 直接跳过
- 目录 - 直接跳过

**第二阶段：文件内容检测（精准识别）**

逐行读取文件（跳过空行），找到第一个非空行，检查是否包含 `PRIVATE KEY` 关键字。

**检测规则**：
- 读取文件直到遇到第一个非空行
- 检查该行是否包含 `PRIVATE KEY` 字符串
- 包含则判定为私钥文件，否则判定为非私钥文件

**覆盖的私钥格式**：
- RSA 私钥：`-----BEGIN RSA PRIVATE KEY-----`
- 通用私钥：`-----BEGIN PRIVATE KEY-----`
- DSA 私钥：`-----BEGIN DSA PRIVATE KEY-----`
- ECDSA 私钥：`-----BEGIN EC PRIVATE KEY-----`
- Ed25519 私钥：`-----BEGIN OPENSSH PRIVATE KEY-----`
- 加密私钥：`-----BEGIN ENCRYPTED PRIVATE KEY-----`

**识别策略**：
- 先通过文件名快速过滤，减少文件读取次数
- 仅对可能的私钥文件读取第一个非空行进行确认
- 内容检测失败（如无法读取）则降级为文件名判断
- 第一个非空行包含 `PRIVATE KEY` 的文件才进行权限检查和修复

**优势**：
- 简洁：单一检测条件，逻辑清晰
- 精准：所有标准私钥格式都包含 `PRIVATE KEY` 标识
- 高性能：只需读取第一个非空行，I/O 开销极小
- 易维护：无需维护多种格式的特征列表

### 二、配置文件自动生成

#### 生成时机

插件初始化时，如果检测到以下文件不存在，则自动生成：

1. `gradle/remote-plugin/remote.yml` - 远程配置文件
2. `gradle/remote-plugin/.ssh/config` - SSH 配置文件
3. `gradle/remote-plugin/.ssh/id_ed25519` - 默认私钥（如果 .ssh 目录下没有任何私钥）

#### 生成条件

- **remote.yml**：如果文件不存在，则生成模板
- **.ssh/config**：如果文件不存在，则生成示例配置
- **私钥**：根据 remote.yml 中的配置决定是否自动生成
  - 配置项：`ssh.setup.auto.keygen`
  - 默认值：`false`（不自动生成）
  - 当设置为 `true` 且 .ssh 目录下没有任何私钥文件时，生成 Ed25519 密钥对

#### 不生成的情况

- 文件已存在 - 不覆盖，保持用户配置
- .ssh 目录下已有任何私钥 - 不自动生成新密钥
- `ssh.setup.auto.keygen` 配置为 `false` 或未配置 - 不自动生成密钥（默认行为）

## 权限标准

### Unix/Linux 权限说明

| 权限值 | 数字表示 | 含义 | 适用场景 |
|-------|---------|------|------|
| 600 | rw------- | 仅所有者可读写 | 私钥 |
| 700 | rwx------ | 仅所有者可读写执行 | .ssh 目录 |

### 为什么需要严格的权限

SSH 对私钥文件权限有严格要求：

1. **安全性**：防止其他用户读取私钥
2. **合规性**：符合 OpenSSH 的安全规范
3. **可用性**：权限不正确时 SSH 客户端会拒绝使用密钥

## 功能设计

### 触发时机

在插件初始化阶段，SSH 配置注入之前自动执行

执行顺序：
1. 环境配置扫描
2. **配置文件自动生成**（新增）
3. **SSH 私钥权限检查和修复**（新增）
4. SSH 配置注入
5. 任务注册

### 处理流程

```mermaid
flowchart TD
    Start[插件初始化] --> GenConfig[配置文件自动生成]
    GenConfig --> CheckRemoteYml{remote.yml 存在?}
    CheckRemoteYml -->|否| GenRemoteYml[生成 remote.yml 模板]
    CheckRemoteYml -->|是| CheckSshConfig{.ssh/config 存在?}
    GenRemoteYml --> CheckSshConfig
    CheckSshConfig -->|否| CreateSshDir[创建 .ssh 目录]
    CreateSshDir --> GenSshConfig[生成 config 模板]
    CheckSshConfig -->|是| CheckPrivateKey{.ssh 下有私钥?}
    GenSshConfig --> CheckPrivateKey
    CheckPrivateKey -->|否| GenKeyPair[生成 Ed25519 密钥对]
    CheckPrivateKey -->|是| PermCheck[私钥权限检查]
    GenKeyPair --> PermCheck
    PermCheck --> CheckSshDir{.ssh 目录存在?}
    CheckSshDir -->|否| Skip[跳过权限检查]
    CheckSshDir -->|是| FixDirPerm[修复 .ssh 目录权限为 700]
    FixDirPerm --> ListFiles[扫描目录下所有文件]
    ListFiles --> LoopFiles{遍历每个文件}
    LoopFiles --> IsPrivateKey{是私钥文件?}
    IsPrivateKey -->|否| NextFile{还有文件?}
    IsPrivateKey -->|是| CheckPerm{权限是否为 600?}
    CheckPerm -->|是| LogSkip[记录：权限正确]
    CheckPerm -->|否| FixPerm[修复权限为 600]
    FixPerm --> LogFixed[记录：已修复权限]
    LogSkip --> NextFile
    LogFixed --> NextFile
    NextFile -->|是| LoopFiles
    NextFile -->|否| Summary[输出处理摘要]
    Summary --> End[继续 SSH 配置注入流程]
    Skip --> End
```

### 核心功能模块

#### 模块一：配置文件自动生成器

**职责**：首次使用时自动生成必要的配置文件和密钥

**主要功能**：

1. **remote.yml 生成**
   - 检查文件是否存在
   - 不存在时生成包含常用配置项的模板
   - 包含环境配置、服务端口、启动命令等示例

2. **.ssh/config 生成**
   - 检查文件是否存在
   - 不存在时生成包含示例 Host 配置的模板
   - 包含必要的注释说明

3. **SSH 密钥对生成**
   - 检查 remote.yml 中的 `ssh.setup.auto.keygen` 配置
   - 默认为 `false`，不自动生成密钥
   - 如果配置为 `true`，检查 .ssh 目录下是否已有私钥
   - 如果配置为 `true` 且没有任何私钥，生成 Ed25519 密钥对
   - 使用 `ssh-keygen` 命令生成（调用系统命令）
   - 设置正确的文件权限

**生成策略**：
- 仅在文件不存在时生成，不覆盖已有文件
- 生成后立即设置正确权限
- 所有操作失败不影响构建流程

#### 模块二：私钥权限检查修复器

**职责**：检测和修复 SSH 私钥文件权限

**主要功能**：

1. **私钥文件识别**
   - 扫描 .ssh 目录下的所有文件
   - 第一阶段：根据文件名快速过滤
   - 第二阶段：读取文件内容检测私钥特征标识
   - 排除公钥、配置文件等非私钥文件

2. **权限检查**
   - 检查私钥文件当前权限
   - 判断是否为 600（仅所有者可读写）

3. **权限修复**
   - 如果权限不正确，修改为 600
   - 同时确保 .ssh 目录权限为 700

4. **日志输出**
   - 输出检测到的私钥文件数量
   - 输出每个文件的处理状态（正确/已修复/失败）
   - 输出处理摘要统计

### 异常处理策略

#### 配置文件生成异常

| 异常场景 | 处理策略 | 用户反馈 |
|---------|---------|------|
| 无法创建目录 | 记录警告，跳过生成 | 输出警告信息 |
| 文件写入失败 | 记录警告，继续构建 | 输出警告信息 |
| ssh-keygen 不存在 | 跳过密钥生成 | 提示用户手动生成密钥 |
| 密钥生成失败 | 记录警告，继续构建 | 输出警告信息 |

#### 权限检查修复异常

| 异常场景 | 处理策略 | 用户反馈 |
|---------|---------|------|
| .ssh 目录不存在 | 跳过权限检查 | 输出提示信息 |
| 无法读取文件权限 | 记录警告，继续处理其他文件 | 输出警告信息 |
| 权限修复失败 | 记录警告，不中断构建 | 输出警告，建议手动修复 |
| Windows 系统 | 跳过权限设置 | 输出提示：Windows 系统无需修复 |
| IO 异常 | 捕获异常，记录日志，继续构建 | 输出警告信息 |

**核心原则**：权限问题不应导致构建失败，应降级处理并提供清晰的用户反馈

## 跨平台兼容性

### Unix/Linux/macOS

**权限检查修复**：完整支持
**配置文件生成**：完整支持
**密钥生成**：依赖系统 `ssh-keygen` 命令

### Windows

**权限检查修复**：检测到 Windows 系统时跳过
- 理由：Windows 文件权限模型不同，SSH 客户端通常不强制要求 Unix 风格权限
- 实现：通过系统属性判断操作系统类型

**配置文件生成**：完整支持
- remote.yml 和 .ssh/config 可正常生成

**密钥生成**：有限支持
- 如果系统安装了 OpenSSH（Windows 10 1809+ 自带），可正常生成
- 如果没有 `ssh-keygen`，跳过密钥生成，提示用户手动创建

## 性能考虑

### 文件扫描优化

- 仅扫描 `.ssh` 目录一层，不递归子目录
- 目录不存在时立即返回
- 配置文件存在性检查使用文件系统快速判断

### 执行时间

预计对构建时间的影响：

| 操作 | 预估耗时 |
|-----|--------|
| remote.yml 存在性检查 | < 1ms |
| .ssh/config 存在性检查 | < 1ms |
| 私钥扫描 | < 5ms |
| 配置文件生成（首次） | < 20ms |
| 密钥生成（首次，调用 ssh-keygen） | 100-500ms |
| 权限检查和修复 | 每个文件 < 5ms |
| **总耗时（非首次）** | < 20ms |
| **总耗时（首次，包含密钥生成）** | < 600ms |

首次使用时耗时稍长，但仅执行一次，后续构建几乎无影响。

## 用户体验

### 首次使用场景（自动生成配置，默认不生成密钥）

```
[remote-plugin] 正在初始化项目配置...
[remote-plugin] ✓ 已生成 remote.yml 配置模板
[remote-plugin] ✓ 已生成 .ssh/config 配置模板
[remote-plugin] ℹ 密钥自动生成已禁用（默认）
[remote-plugin] 提示：如需自动生成密钥，请在 remote.yml 中设置 ssh.setup.auto.keygen: true
[remote-plugin] 配置初始化完成，请根据实际情况修改 remote.yml
```

### 首次使用场景（启用密钥自动生成）

```
[remote-plugin] 正在初始化项目配置...
[remote-plugin] ✓ 已生成 remote.yml 配置模板
[remote-plugin] ✓ 已生成 .ssh/config 配置模板
[remote-plugin] ✓ 已生成 SSH 密钥对 (Ed25519)
[remote-plugin]   私钥: gradle/remote-plugin/.ssh/id_ed25519
[remote-plugin]   公钥: gradle/remote-plugin/.ssh/id_ed25519.pub
[remote-plugin] ✓ 已设置私钥权限 (600)
[remote-plugin] 配置初始化完成，请根据实际情况修改 remote.yml
```

### 正常使用场景（权限修复）

```
[remote-plugin] 检查 SSH 私钥文件权限...
[remote-plugin] 找到 2 个私钥文件
[remote-plugin] ✓ id_ed25519 - 权限正确 (600)
[remote-plugin] ✓ id_rsa - 已修复权限 (600)
[remote-plugin] SSH 私钥权限检查完成
```

### 无需处理场景

```
[remote-plugin] 检查 SSH 私钥文件权限...
[remote-plugin] 找到 1 个私钥文件，权限均正确
```

### 警告场景

```
[remote-plugin] ⚠ 无法修复私钥权限：id_rsa (Permission denied)
[remote-plugin] 建议手动执行：chmod 600 gradle/remote-plugin/.ssh/id_rsa
```

### Windows 系统场景

```
[remote-plugin] 检测到 Windows 系统，跳过权限检查
[remote-plugin] 配置文件检查完成
```

## 安全考虑

### 密钥生成安全性

- 使用 Ed25519 算法（现代、安全、高效）
- 密钥仅生成在项目目录下，不影响系统级配置
- 生成后立即设置正确权限（600）
- 不自动上传公钥，由用户决定如何分发

### 权限修复安全性

- 仅收紧权限（设置为 600），不放宽
- 仅修改项目目录下的文件
- 修复前验证目标文件确实位于项目的 .ssh 目录下

### 日志安全

- 不输出私钥内容
- 使用相对路径而非绝对路径
- 仅输出操作结果和统计信息

### 配置文件安全

- 生成的模板不包含真实密码或 token
- 使用占位符或示例值
- 提示用户修改为实际配置

## 测试场景

### 配置文件生成测试

| 测试场景 | 前置条件 | 预期结果 |
|---------|---------|------|
| 完全空项目 | 无任何配置文件 | 生成 remote.yml、.ssh/config，不生成密钥（默认） |
| 完全空项目 + auto.keygen=true | 无任何配置文件，配置启用密钥生成 | 生成 remote.yml、.ssh/config、密钥对 |
| 仅有 remote.yml | remote.yml 存在 | 仅生成 .ssh/config，根据配置决定是否生成密钥 |
| 仅有 .ssh/config | .ssh/config 存在 | 仅生成 remote.yml，根据配置决定是否生成密钥 |
| 已有私钥 | .ssh 下已有任意私钥 | 不生成新密钥，仅检查权限 |
| ssh-keygen 不存在 | 系统没有 ssh-keygen 命令 | 跳过密钥生成，输出提示 |
| 文件创建失败 | 无写入权限 | 记录警告，继续构建 |
| auto.keygen 未配置 | remote.yml 中没有该配置项 | 默认为 false，不生成密钥 |

### 权限检查修复测试

| 测试场景 | 前置条件 | 预期结果 |
|---------|---------|------|
| 首次克隆代码 | 私钥权限为 644 | 自动修复为 600 |
| 权限已正确 | 所有私钥权限为 600 | 检测通过，无修复操作 |
| 混合权限 | 部分私钥权限正确，部分不正确 | 仅修复不正确的私钥 |
| 无 .ssh 目录 | 项目无 .ssh 目录 | 自动生成（如果需要）|
| 空 .ssh 目录 | .ssh 存在但无私钥 | 生成密钥对 |
| 仅有公钥 | .ssh 下仅有 .pub 文件 | 跳过公钥，不修复权限 |
| Windows 环境 | 在 Windows 系统运行 | 跳过权限检查 |

### 边界测试场景

| 测试场景 | 预期行为 |
|---------|------|
| 私钥文件名不规范（如 my_private_key.pem） | 通过内容检测正确识别并修复权限 |
| 公钥文件混在一起 | 仅处理私钥，跳过公钥 |
| 文件名像私钥但内容不是 | 通过内容检测正确识别为非私钥，跳过 |
| 符号链接 | 跳过，不修复 |
| 只读私钥文件 | 尝试修复，失败则记录警告 |
| 无权限的目录 | 捕获异常，记录警告，继续构建 |
| 文件读取失败 | 降级为文件名判断，记录警告 |

## 后续扩展可能性

### 潜在功能增强

1. **智能密钥检测**
   - 检查私钥格式是否正确（PEM、OpenSSH 等）
   - 验证公钥与私钥是否匹配
   - 检测私钥是否有密码保护

2. **配置模板定制**
   - 支持自定义 remote.yml 模板
   - 根据项目类型生成不同的配置
   - 提供多种预设模板（单服务器、多环境等）

3. **配置验证**
   - 检查 remote.yml 语法和必需字段
   - 验证 .ssh/config Host 配置的完整性
   - 检测 Host 名称冲突

4. **多密钥管理**
   - 支持为不同环境使用不同密钥
   - 自动关联 Host 和对应的私钥

5. **交互式初始化**
   - 提供 Gradle Task 进行交互式配置
   - 引导用户填写服务器信息
   - 自动生成完整的配置文件

## 与现有功能的集成

### 调用位置

在 `RemotePlugin.apply()` 方法中，在环境配置扫描后、SSH 配置注入前调用：

```
环境配置扫描
    ↓
配置文件自动生成（新增）
    ↓
SSH 私钥权限检查修复（新增）
    ↓
SSH 配置自动注入
    ↓
任务注册
```

### 代码组织

由于功能相对复杂（包含配置生成和权限管理），建议创建独立工具类：

**新增文件**：`src/main/kotlin/io/github/iuin8/remote/SshSetupManager.kt`

**类结构**：
- 单例对象（object）
- 主入口方法：`setupProjectSsh(projectRootDir: File)`
- 内部模块：
  - 配置文件生成模块（`generateConfigFiles`）
  - 密钥生成模块（`generateSshKeyPair`）
  - 私钥权限检查修复模块（`fixPrivateKeyPermissions`）
- 辅助方法：
  - 私钥文件名检查（`matchesPrivateKeyFileName`）
  - 私钥内容检测（`containsPrivateKeyMarker` - 检测第一个非空行是否包含 PRIVATE KEY）
  - 私钥识别（`isPrivateKeyFile` - 组合文件名和内容检测）
  - 系统检测（`isWindows`）
  - 权限设置（`setFilePermissions`）
  - 模板内容（`getRemoteYmlTemplate`、`getSshConfigTemplate`）

**调用方式**：
```kotlin
// 在 RemotePlugin.apply() 中
SshSetupManager.setupProjectSsh(project.rootDir)
```

### 配置选项

通过 remote.yml 提供配置控制：

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| ssh.setup.auto.keygen | false | 是否自动生成密钥对 |
| ssh.setup.key.type | ed25519 | 密钥类型（ed25519/rsa）|

**配置示例**：

```yaml
# SSH 自动配置选项
ssh:
  setup:
    auto:
      keygen: true  # 设置为 true 启用自动生成密钥
    key:
      type: ed25519  # 密钥类型
```

**默认行为**：
- 如果 remote.yml 中未配置 `ssh.setup.auto.keygen`，默认为 `false`，不自动生成密钥
- 用户需要手动创建密钥或显式配置 `auto.keygen: true` 来启用自动生成

## 实现优先级

### P0 核心功能（必须实现）

**配置文件自动生成**：
- remote.yml 模板生成
- .ssh/config 模板生成
- SSH 密钥对自动生成（Ed25519）
- 生成时设置正确权限

**私钥权限检查修复**：
- 私钥文件识别（文件名初筛 + 内容检测）
- 私钥权限检查（600）
- .ssh 目录权限检查（700）
- 权限自动修复
- 基本日志输出

### P1 增强功能（推荐实现）

- Windows 系统兼容处理（跳过权限检查）
- 详细的日志输出和处理摘要
- 异常捕获和降级处理（失败不中断构建）
- ssh-keygen 命令存在性检查
- 私钥文件扩展识别（包含 private 关键字）
- 文件内容检测的性能优化（仅读取第一个非空行）

### P2 可选功能（未来扩展）

- 通过 remote.yml 控制自动生成行为
- 支持 RSA 密钥类型选择
- 密钥格式验证
- 配置文件语法验证
- 交互式配置生成

## 配置文件模板内容

### remote.yml 模板

生成的 remote.yml 应包含常用配置项和注释说明：

**必需内容**：
- 环境配置示例（dev/test/prod）
- 服务端口配置
- 启动命令配置
- 日志文件路径配置
- **SSH 配置选项**：
  ```yaml
  # SSH 自动配置选项（可选）
  ssh:
    setup:
      auto:
        keygen: false  # 是否自动生成密钥，默认 false
      key:
        type: ed25519  # 密钥类型，默认 ed25519
  ```

**可选内容**：
- Jenkins 配置示例（注释状态）
- 环境变量配置示例
- 详细的配置说明注释

**模板参考**：参考现有 `consumer-gradle6-sample/gradle/remote-plugin/remote.yml`

### .ssh/config 模板

生成的 .ssh/config 应包含：

**必需内容**：
- 文件用途说明注释
- Host 配置示例（注释状态）
- IdentityFile 路径示例（指向项目 .ssh 目录）

**注意事项**：
- 提示用户避免 Host 名称冲突
- 说明文件会被自动注入到系统 SSH 配置

**模板参考**：参考现有 `consumer-gradle6-sample/gradle/remote-plugin/.ssh/config`

### 密钥生成参数

**密钥类型**：Ed25519（现代、安全、高效）

**生成命令**：
```
ssh-keygen -t ed25519 -f <path> -N "" -C "<comment>"
```

**参数说明**：
- `-t ed25519`：密钥类型
- `-f <path>`：输出路径（`gradle/remote-plugin/.ssh/id_ed25519`）
- `-N ""`：无密码保护（便于自动化使用）
- `-C "<comment>"`：注释（如 "Generated by Gradle Remote Plugin"）

**生成文件**：
- 私钥：`id_ed25519`（权限 600）
- 公钥：`id_ed25519.pub`（权限 644，自动生成）

## 文档更新需求

### README 文档

需要新增章节或更新现有章节：

**新增内容要点**：
1. **快速开始 / 零配置使用**
   - 说明首次使用会自动生成配置
   - 生成的文件列表和位置
   - 需要用户手动修改的配置项（服务器地址等）

2. **SSH 私钥权限管理**
   - 自动修复私钥权限说明
   - 支持的私钥文件类型
   - Windows 系统说明

3. **配置文件说明**
   - remote.yml 配置项详解
   - .ssh/config 使用说明
   - 公钥分发指引

**建议位置**：
在 "Installation" 之后，"Usage" 之前，新增 "Quick Start" 章节

### 实现总结文档

需要创建或更新实现总结文档：
- 配置自动生成功能实现说明
- 私钥权限检查修复功能实现说明
- 新增的代码文件清单（`SshSetupManager.kt`）
- 测试验证结果
- 与现有功能的集成点

## 成功标准

### 功能完整性

**配置文件自动生成**：
- ✅ 首次使用能自动生成 remote.yml 模板
- ✅ 首次使用能自动生成 .ssh/config 模板
- ✅ 支持通过配置控制是否自动生成密钥
- ✅ 默认不自动生成密钥（ssh.setup.auto.keygen 默认为 false）
- ✅ 配置为 true 时能自动生成 Ed25519 密钥对
- ✅ 已有配置文件时不覆盖
- ✅ 生成失败不影响构建流程

**私钥权限检查修复**：
- ✅ 能够正确识别常见的 SSH 私钥文件
- ✅ 能够检测私钥权限是否为 600
- ✅ 能够自动修复不正确的权限
- ✅ 不处理公钥、config 等非私钥文件
- ✅ 在各种异常情况下不影响构建流程

### 用户体验

**零配置目标**：
- ✅ 首次使用时自动生成必需的配置文件模板
- ✅ 密钥生成可配置，默认提示用户手动创建或启用自动生成
- ✅ 克隆代码后无需手动设置权限
- ✅ 清晰的日志输出，告知用户生成了什么
- ✅ 提示用户需要修改的配置项（服务器地址等）
- ✅ Windows 系统不产生困惑或错误

### 代码质量

- ✅ 代码结构清晰，职责分明
- ✅ 单独的工具类，易于维护
- ✅ 完善的异常处理
- ✅ 符合项目现有代码风格（参考 SshConfigManager）
- ✅ 适当的注释和文档

### 性能

- ✅ 非首次使用时耗时 < 20ms
- ✅ 首次使用时耗时 < 600ms（包含密钥生成）
- ✅ 仅在必要时执行文件操作

## 风险评估

### 潜在风险

| 风险 | 影响 | 缓解措施 |
|------|------|------|
| 自动生成配置覆盖用户自定义内容 | 高 | 仅在文件不存在时生成，不覆盖已有文件 |
| ssh-keygen 命令不存在 | 中 | 检测命令存在性，不存在时跳过并提示用户 |
| 密钥生成失败 | 中 | 捕获异常，记录警告，继续构建 |
| 权限修复失败导致无法使用 SSH | 中 | 提供清晰的错误信息和手动修复指引 |
| Windows 系统兼容性问题 | 中 | 检测系统类型，跳过权限检查 |
| 误识别文件类型导致错误修复 | 低 | 采用保守的识别规则，仅处理明确的私钥文件 |
| 生成的模板不符合用户需求 | 低 | 提供通用模板和详细注释，用户可自行修改 |
| 性能影响 | 低 | 优化逻辑，首次使用稍慢但可接受 |

### 回退方案

如果自动生成或权限修复功能导致问题，用户可以：

1. **删除生成的文件，手动创建配置**
   - 删除自动生成的 remote.yml 和 .ssh/config
   - 根据实际需求手动创建配置文件

2. **手动设置文件权限**
   - 执行 `chmod 600 gradle/remote-plugin/.ssh/id_*`
   - 执行 `chmod 700 gradle/remote-plugin/.ssh`

3. **使用系统级 SSH 配置**
   - 不使用项目级 .ssh 配置
   - 在 ~/.ssh/config 中配置
   - 在 ~/.ssh/ 中管理密钥

4. **未来版本通过配置禁用**
   - 在 remote.yml 中设置 `ssh.setup.auto.generate: false`（需实现）

## 实现建议

### 开发步骤

**第一阶段：配置文件生成**
1. 创建 `SshSetupManager` 工具类
2. 实现 remote.yml 模板生成逻辑
3. 实现 .ssh/config 模板生成逻辑
4. 实现配置读取逻辑（读取 ssh.setup.auto.keygen 配置）
5. 实现 SSH 密钥对生成逻辑（根据配置决定是否生成）
6. 添加系统命令存在性检查
7. 添加日志输出

**第二阶段：权限检查修复**
8. 实现私钥文件名初筛逻辑
9. 实现私钥内容检测逻辑（读取第一个非空行，检查是否包含 PRIVATE KEY）
10. 实现权限检查逻辑
11. 实现权限修复逻辑
12. 处理跨平台兼容性（Windows 跳过）
13. 完善异常处理

**第三阶段：集成和测试**
14. 集成到 `RemotePlugin` 初始化流程
15. 测试各种场景（首次使用、已有配置、权限修复等）
16. 测试配置控制（auto.keygen 为 true/false 的不同行为）
17. 优化日志输出
18. 更新文档（README、实现总结）

### 代码质量要求

- 遵循 Kotlin 编码规范
- 参考 `SshConfigManager` 的代码风格
- 方法职责单一，每个方法不超过 30 行
- 使用有意义的变量和方法命名
- 添加必要的注释说明（特别是模板内容）
- 异常处理不遗漏任何场景
- 所有文件操作都要有异常捕获

### 测试要求

**配置文件生成测试**：
- 完全空项目测试（生成配置文件，默认不生成密钥）
- 启用密钥生成配置测试（ssh.setup.auto.keygen: true）
- 部分配置存在测试（仅生成缺失的）
- 已有私钥测试（不生成新密钥）
- ssh-keygen 不存在测试（跳过密钥生成）
- 配置项读取测试（正确读取 ssh.setup.auto.keygen 配置）

**权限检查修复测试**：
- macOS/Linux 环境测试权限修复功能
- Windows 环境测试跳过逻辑
- 验证私钥文件识别正确性：
  - 正确识别各种格式的私钥（RSA、DSA、ECDSA、Ed25519）
  - 正确排除公钥文件
  - 正确排除非私钥文件（如文本文件、配置文件）
  - 文件名相似但内容不是私钥的文件能正确识别
- 测试异常场景的处理（文件读取失败、无权限等）

**集成测试**：
- 在示例项目（consumer-gradle6-sample）中测试
- 删除配置文件后重新运行，验证自动生成
- 修改私钥权限后重新运行，验证自动修复
8. 实现私钥文件名初筛逻辑
9. 实现私钥内容检测逻辑（读取第一个非空行，检查是否包含 PRIVATE KEY）
10. 实现权限检查逻辑
11. 实现权限修复逻辑
12. 处理跨平台兼容性（Windows 跳过）
13. 完善异常处理

**第三阶段：集成和测试**
14. 集成到 `RemotePlugin` 初始化流程
15. 测试各种场景（首次使用、已有配置、权限修复等）
16. 测试配置控制（auto.keygen 为 true/false 的不同行为）
17. 优化日志输出
18. 更新文档（README、实现总结）

### 代码质量要求

- 遵循 Kotlin 编码规范
- 参考 `SshConfigManager` 的代码风格
- 方法职责单一，每个方法不超过 30 行
- 使用有意义的变量和方法命名
- 添加必要的注释说明（特别是模板内容）
- 异常处理不遗漏任何场景
- 所有文件操作都要有异常捕获

### 测试要求

**配置文件生成测试**：
- 完全空项目测试（生成配置文件，默认不生成密钥）
- 启用密钥生成配置测试（ssh.setup.auto.keygen: true）
- 部分配置存在测试（仅生成缺失的）
- 已有私钥测试（不生成新密钥）
- ssh-keygen 不存在测试（跳过密钥生成）
- 配置项读取测试（正确读取 ssh.setup.auto.keygen 配置）

**权限检查修复测试**：
- macOS/Linux 环境测试权限修复功能
- Windows 环境测试跳过逻辑
- 验证私钥文件识别正确性：
  - 正确识别各种格式的私钥（RSA、DSA、ECDSA、Ed25519）
  - 正确排除公钥文件
  - 正确排除非私钥文件（如文本文件、配置文件）
  - 文件名相似但内容不是私钥的文件能正确识别
- 测试异常场景的处理（文件读取失败、无权限等）

**集成测试**：
- 在示例项目（consumer-gradle6-sample）中测试
- 删除配置文件后重新运行，验证自动生成
- 修改私钥权限后重新运行，验证自动修复
