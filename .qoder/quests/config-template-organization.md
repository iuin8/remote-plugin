# 配置模板组织方案设计文档

## 1. 概述

本设计文档旨在规范Gradle远程插件中配置模板的组织方式。当前版本中，配置模板内容硬编码在`SshSetupManager.kt`文件中，不利于维护和扩展。通过将这些模板提取到独立的模板文件中，并放置在专门的模板目录中，可以提高代码的可维护性和清晰度。

## 2. 设计目标

- 将硬编码在源代码中的配置模板提取为独立的文件
- 创建统一的模板目录结构用于存放所有配置模板
- 保持现有功能不变，仅优化模板存储方式
- 提高配置模板的可维护性和可读性

## 3. 当前实现分析

目前，插件中有两个主要的配置模板：

1. `remote.yml`模板：定义了远程部署的基本配置结构
2. `.ssh/config`模板：定义了SSH连接的基本配置结构

这两个模板都以内联字符串的形式硬编码在`SshSetupManager.kt`文件的以下方法中：
- `getRemoteYmlTemplate()`
- `getSshConfigTemplate()`

## 4. 新设计方案

### 4.1 目录结构调整

创建新的资源目录结构来存放模板文件：

```
src/
└── main/
    └── resources/
        └── templates/
            ├── remote-plugin/
            │   └── remote.yml.template
            └── ssh/
                └── config.template
```

### 4.2 模板文件内容

#### 4.2.1 remote.yml.template

该文件将包含原来`getRemoteYmlTemplate()`方法中的内容：

```yaml
# Remote plugin configuration template
# Generated by Gradle Remote Plugin

# SSH 自动配置选项（可选）
# ssh:
#   setup:
#     auto:
#       keygen: false  # 是否自动生成密钥，默认 false
#     key:
#       type: ed25519  # 密钥类型，默认 ed25519

# Jenkins configuration (optional)
# jenkins:
#   url: "https://your-jenkins-url.com"
#   user: "your_username"
#   token: "your_api_token"
#   jobs:
#     job1: "your-job-name"

# Environment configurations
# Each environment can have its own settings
environments:
  # Development environment configuration
  dev:
    remote:
      server: your-server-hostname
      base:
        dir: /path/to/your/app
  
  # Test environment configuration
  # test:
  #   remote:
  #     server: test-server-hostname
  #     base:
  #       dir: /path/to/your/app

# Service ports configuration
service:
  ports:
    app: 8080
  start:
    # command: \${REMOTE_BASE_DIR}/\${SERVICE_NAME}/\${SERVICE_NAME}-start.sh
    command: sudo systemctl restart \${SERVICE_NAME}
  env:
    # JDK 8
    # JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=3\${SERVICE_PORT}
    # JDK 9+
    JAVA_TOOL_OPTIONS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:3\${SERVICE_PORT}

# Log file pattern configuration
log:
  filePattern: \${REMOTE_BASE_DIR}/../logs/\${service}.log

# Supported placeholders:
#   - \${service}            : current Gradle project name
#   - \${REMOTE_BASE_DIR}    : value of remote.base.dir
#   - \${remote.base.dir}    : same as above
```

#### 4.2.2 config.template

该文件将包含原来`getSshConfigTemplate()`方法中的内容：

```
# SSH Config for Gradle Remote Plugin
# Generated by Gradle Remote Plugin
# This file will be automatically included in your system SSH config

# Example Host Configuration
# Host your-server-alias
#   HostName your-server-hostname.com
#   User your-username
#   IdentityFile ../gradle/remote-plugin/.ssh/id_ed25519
#   Port 22

# Add your SSH configurations below
# Make sure the Host names are unique to avoid conflicts with other projects
# See: https://www.ssh.com/academy/ssh/config
```

### 4.3 代码修改方案

需要修改`SshSetupManager.kt`文件中的相关方法，使其从资源文件中读取模板内容而不是使用硬编码字符串：

1. 删除`getRemoteYmlTemplate()`和`getSshConfigTemplate()`方法
2. 修改`generateRemoteYml()`和`generateSshConfig()`方法，使其从资源文件中加载模板内容
3. 使用标准的Java资源加载机制读取模板文件

## 5. 实施步骤

1. 创建`src/main/resources/templates`目录结构
2. 创建`remote.yml.template`和`config.template`文件并添加相应内容
3. 修改`SshSetupManager.kt`中的模板加载逻辑
4. 测试配置生成功能确保与之前行为一致
5. 更新相关文档说明新的模板组织方式

## 6. 后续优化建议

1. 可以考虑支持多种格式的模板引擎（如Freemarker、Thymeleaf等）来增强模板功能
2. 添加模板验证机制，确保模板文件的完整性和正确性
3. 提供模板覆盖机制，允许用户自定义模板而不会被插件更新覆盖2. 添加模板验证机制，确保模板文件的完整性和正确性
3. 提供模板覆盖机制，允许用户自定义模板而不会被插件更新覆盖