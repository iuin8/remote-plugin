# Gradle Remote Plugin 使用指南 (v1.4.1)

[English Documentation](README.md) | [Changelog](CHANGELOG.md)

`io.github.iuin8.remote` 是一个功能强大的 Gradle 插件，专注于简化远程服务器部署、自动化运维及 Jenkins 集成。

## 1. 核心特性

- **高性能加载**：配置前置预加载，整个构建生命周期内 `remote.yml` 仅加载一次，零冗余开销。
- **生产环境防护**：智能识别 `prod` 环境，执行敏感任务前自动弹出安全确认提醒。
- **免配置 SSH 增强**：自动管理项目级 SSH 配置与密钥，支持 PTY 仿真以显示远程进度条。
- **极致简洁输出**：默认仅显示核心进度，初始化及背景日志已移至 DEBUG 级别。
- **环境任务分组**：任务按环境（如 `remote-prod`、`remote-test`）自动分组，防止 IDE 任务列表过载。
- **Jenkins 深度集成**：支持触发构建、查看状态、追踪提交记录及显示触发者信息。

## 2. 快速开始

### 引入插件

```groovy
plugins {
    id 'io.github.iuin8.remote' version '1.4.1'
}
```

### 环境配置 (`gradle/remote-plugin/remote.yml`)

插件底层采用 YAML 配置，支持多环境继承：

```yaml
common:
  base:
    ssh.user: root
    remote.base_dir: /app/data
    start.need_confirm: true  # 是否开启二次确认

service_ports:
  app-module: 8080

environments:
  test:
    ssh.server: test-server
    start.need_confirm: false
  prod:
    ssh.server: prod-server
```

## 3. 常用任务

插件根据 `environments` 自动生成对应的环境任务：

- `./gradlew {env}_publish`：发布制品并启动（支持 `bootJar` 自动依赖）。
- `./gradlew {env}_restart`：远程重启服务。
- `./gradlew {env}_log`：实时查看远程日志。
- `./gradlew {env}_arthas`：一键连接远程 Arthas（端口自动映射）。
- `./gradlew {env}_jenkins_build`：触发 Jenkins 构建任务。

## 4. SSH 配置管理 (Zero-Config)

### 配置文件位置
插件会自动识别并加载项目内的 SSH 配置：
`gradle/remote-plugin/.ssh/config`

### 配置示例
```ssh
Host prod-server
  HostName 192.168.1.100
  User root
  IdentityFile ~/.ssh/id_ed25519
```

### 自动注入
插件会自动将上述配置引用到系统的 `~/.ssh/config` 中，实现“拉下代码即用”，无需手动配置 SSH 免密或 Alias。

## 5. 高级操作

### 跳过确认环节
在 CI/CD 或自动化脚本中，可以通过命令行参数跳过生产环境确认：
```bash
./gradlew prod_publish -Pstart.need_confirm=false
```

### 查看详细日志
默认日志非常精简，如需调试，请增加 `--debug` 参数：
```bash
./gradlew prod_publish --debug
```

## 6. 常见问题
- 401 Unauthorized：检查用户名/密码，或账户是否有 deploy 权限；确认仓库 URL 与发布类型（Releases/Snapshots）匹配。
- 404/405：通常是仓库地址不正确，务必使用阿里云控制台提供的 Maven 地址（注意末尾路径）。
- 消费端无法解析插件 ID：确认消费端 settings.gradle 的 `pluginManagement.repositories` 已包含你的私有仓库，并且已发布了插件 Marker 包。
- 公司网络代理/证书：如需代理，在 `~/.gradle/gradle.properties` 配置 `systemProp.http.proxyHost` 等；如需自签证书信任，按公司规范配置 JVM 信任库。

## 配置文件与脚本位置
- 统一配置文件：`gradle/remote-plugin/remote.yml`
- 端口配置示例：
```yaml
service:
  ports:
    app: 8080
```
- 日志配置示例：
```yaml
log:
  filePattern: ${REMOTE_BASE_DIR}/../logs/${service}.log
```
- 说明：服务端口在service_ports下配置，key为子模块名称；Arthas端口为`1`+服务端口（例如`8080 -> 18080`）。
- 发布脚本路径：`gradle/remote-plugin/publish-service.sh`，插件在执行发布任务时会将此目录作为工作目录。
- 缺失提示：当配置文件不存在或缺少端口配置时，插件会在控制台打印示例内容与路径提示，便于补全配置。

## SSH 配置管理

插件支持自动管理 SSH 配置，实现项目级 SSH 配置的开箱即用。

### 配置文件位置

在项目的插件配置目录下创建 SSH 配置文件：
```
<项目根目录>/gradle/remote-plugin/.ssh/config
```

### 配置示例

```ssh
Host cloudflared.fa.internet.company
  HostName ssh-fa-ssy-edgeone-cn.iuin888vip.icu
  User root
  IdentityFile ~/.ssh/id_ed25519_iu
  ProxyCommand cloudflared access ssh --hostname %h --protocol quic
```

### 自动注入机制

当项目中存在 `gradle/remote-plugin/.ssh/config` 文件时，插件初始化时会自动：

1. **第一层：系统配置注入**
   - 在 `~/.ssh/config` 文件开头添加插件配置引用（仅首次）：
   ```
   # Auto-generated by Gradle Remote Plugin
   # DO NOT EDIT THIS BLOCK MANUALLY
   Include ~/.ssh/gradle/remote-plugin/*
   ```

2. **第二层：项目配置注入**
   - 在 `~/.ssh/gradle/remote-plugin/config` 中添加当前项目的配置引用：
   ```
   # Project: <项目名>
   # Path: <项目路径>
   Include <项目根目录>/gradle/remote-plugin/.ssh/config
   ```

### 配置结构

```
~/.ssh/config (系统配置)
  ↓ Include
~/.ssh/gradle/remote-plugin/config (插件管理配置)
  ↓ Include
  ├─ 项目1/gradle/remote-plugin/.ssh/config
  ├─ 项目2/gradle/remote-plugin/.ssh/config
  └─ 项目N/gradle/remote-plugin/.ssh/config
```

### 重要提醒

⚠️ **避免 Host 名称冲突**

- SSH 配置使用“首次匹配”原则，遇到第一个匹配的 Host 就停止查找
- 不同项目的 `.ssh/config` 中不要配置相同的 Host 名称
- 发生 Host 名称冲突时，只有最先匹配到的配置会生效
- 项目配置通过 Include 引入，优先级高于系统配置中的后续定义

### 版本控制建议

- `remote.yml`：建议纳入 Git 管理，便于团队共享环境配置
- `.ssh/config`：根据实际情况选择
  - 如果包含敏感信息（私有主机地址、用户名等），建议添加到 `.gitignore`
  - 如果是通用配置（如跳板机配置），可以纳入版本管理

### 配置管理优势

- ✅ 项目级配置，不同项目互不干扰
- ✅ 自动注入，无需手动修改系统配置
- ✅ 集中管理，所有项目配置统一维护
- ✅ 开箱即用，克隆项目后自动生效

## 7. 更多文档
- [版本更新日志 (Changelog)](CHANGELOG.md)
- [英文文档 (English)](README.md)
- [示例项目](consumer-gradle6-sample/)
